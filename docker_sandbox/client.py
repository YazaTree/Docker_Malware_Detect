from pymongo import MongoClient
import sys
sys.path.append('/home/jagym105/docker_sandbox/sandbox')
sys.path.append('/home/jagym105/docker_sandbox/static_analysis')
import sandbox
import static_analysis
import time
def main():

    # Connect to MongoDB
    client = MongoClient('ec2-54-180-32-193.ap-northeast-2.compute.amazonaws.com', 27017)

    # Access the database
    db = client['Dockerweb']

    # Access the collection
    collection = db['docker_img']

    # Define projection to include or exclude fields
    projection = {
        '_id': 0,           # Exclude the '_id' field
        'ImageName': 1,  # Include 'column_name1'
    }
    
   

    #db에 아무것도 안들어있을 경우를 대비한 예외처리
    while True:
        list_data = []
        while not list_data:
            time.sleep(3)
            data = collection.find({}, projection)
            list_data = list(data)
        # Iterate over the data
        docker_img_name = list_data[0]['ImageName']
        print(docker_img_name)
        
        static_analysis.static_analysis(docker_img_name)   
        sandbox.run_sandbox(docker_img_name)
        
        # Define the filter to specify the documents to update
        filter = {'ImageName': docker_img_name}

        # Perform the update operation
        result = collection.delete_one(filter)
        # Print the number of documents updated
        print('Documents updated:', result.deleted_count)

        # Close the connection
main()